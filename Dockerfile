# Build stage - build the jar file
# Use maven:3.8.6-eclipse-temurin-8-alpine as the base image
# Platform support for M1 Mac: https://stackoverflow.com/a/71388276/19493140
# This Dockerfile is set up to work on M1 Macs as well as other platforms
FROM --platform=linux/amd64 maven:3.8.6-eclipse-temurin-8-alpine as build

# Set the working directory inside the container to /app
WORKDIR /app

# Copy the contents of the current directory (.) into the container at /app
COPY . /app

# Run Maven to build the project and package it into a JAR file
RUN mvn clean install

# Runtime stage - use OpenJDK as the base image
FROM openjdk:8-jre-alpine

# Set the shell to bash
# Source: https://stackoverflow.com/a/40944512/3128926
RUN apk update && apk add bash

# Install Java 8 JRE if you use alpine:3.15
# RUN apk add --no-cache openjdk8-jre

# Set the working directory inside the container to /app
WORKDIR /app

# Copy the JAR file from the build stage into the container at /app
COPY --from=build /app/target/text4shell-poc.jar /app

# Expose port 8080 to the world outside the container
EXPOSE 8080

# Set labels for the image
LABEL maintainer="Enes Turan"
LABEL version="1.0"
LABEL description="Docker Image for text4shell-poc"

# Run the JAR file when the container launches
CMD ["java", "-jar", "text4shell-poc.jar"]
